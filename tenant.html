<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>‡∏´‡∏≠‡∏û‡∏±‡∏Å ‚Äî ‡∏ú‡∏π‡πâ‡πÄ‡∏ä‡πà‡∏≤</title>
<link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&family=Prompt:wght@400;600;700;800&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
:root{
  --bg:#080d16;--surf:#0f1828;--surf2:#162035;--surf3:#1c2a45;
  --border:#1e2d47;--border2:#263852;
  --water:#38bdf8;--elec:#fbbf24;--rent:#a78bfa;
  --ok:#34d399;--warn:#fb923c;--danger:#f87171;
  --text:#e2e8f0;--muted:#556270;--radius:18px;
}
*{box-sizing:border-box;margin:0;padding:0}
body{background:var(--bg);color:var(--text);font-family:'Sarabun',sans-serif;min-height:100vh}
body::before{content:'';position:fixed;inset:0;pointer-events:none;z-index:0;
  background:radial-gradient(ellipse 80% 60% at 50% -20%,rgba(56,189,248,.1) 0%,transparent 60%),
             radial-gradient(ellipse 50% 40% at 10% 90%,rgba(167,139,250,.06) 0%,transparent 60%)}

/* CONFIG BANNER */
#configBanner{position:fixed;top:0;left:0;right:0;z-index:999;background:#7c3aed;color:#fff;
  text-align:center;padding:10px 16px;font-size:13px;font-weight:600;display:none}

/* SCREENS */
.screen{display:none;min-height:100vh;position:relative;z-index:1}
.screen.active{display:block}

/* ===== LOGIN SCREEN ===== */
#screen-login{display:flex;align-items:center;justify-content:center;padding:20px}
.login-box{background:var(--surf);border:1px solid var(--border);border-radius:24px;
  padding:36px 28px;max-width:380px;width:100%;animation:fadeUp .5s ease both}
.login-logo{text-align:center;margin-bottom:28px}
.login-logo .icons{display:inline-flex;gap:6px;margin-bottom:12px}
.login-logo .icons span{width:40px;height:40px;border-radius:12px;display:flex;
  align-items:center;justify-content:center;font-size:20px}
.ico-w{background:rgba(56,189,248,.12)} .ico-e{background:rgba(251,191,36,.12)}
.login-logo h1{font-family:'Prompt',sans-serif;font-size:20px;font-weight:800;margin-bottom:4px}
.login-logo p{font-size:13px;color:var(--muted)}
.fg{display:flex;flex-direction:column;gap:6px;margin-bottom:14px}
label{font-size:11px;font-weight:700;color:var(--muted);letter-spacing:.04em}
input{background:var(--surf2);border:1px solid var(--border);border-radius:10px;
  color:var(--text);font-family:'Sarabun',sans-serif;font-size:15px;padding:11px 14px;
  outline:none;transition:border-color .2s,box-shadow .2s;width:100%}
input:focus{border-color:var(--water);box-shadow:0 0 0 3px rgba(56,189,248,.1)}
input::placeholder{color:var(--muted)}
.login-err{color:var(--danger);font-size:13px;text-align:center;margin-bottom:10px;
  background:rgba(248,113,113,.08);border:1px solid rgba(248,113,113,.2);border-radius:9px;padding:9px;display:none}
.login-note{font-size:12px;color:var(--muted);text-align:center;margin-top:14px;line-height:1.7}
.supa-note{margin-top:20px;padding:12px;background:rgba(124,58,237,.1);border:1px solid rgba(124,58,237,.25);
  border-radius:10px;font-size:12px;color:#c4b5fd;text-align:center}
.supa-note input{font-size:12px;padding:7px 10px;margin-top:8px}

/* BUTTONS */
.btn{padding:11px 20px;border-radius:11px;border:none;font-family:'Prompt',sans-serif;
  font-size:14px;font-weight:700;cursor:pointer;transition:transform .15s,box-shadow .15s,opacity .15s;
  display:inline-flex;align-items:center;gap:7px}
.btn-primary{background:linear-gradient(135deg,#38bdf8,#0ea5e9);color:#fff;box-shadow:0 3px 14px rgba(56,189,248,.3)}
.btn-primary:hover{transform:translateY(-1px);box-shadow:0 6px 20px rgba(56,189,248,.4)}
.btn-success{background:linear-gradient(135deg,#34d399,#10b981);color:#051a0e;box-shadow:0 3px 14px rgba(52,211,153,.3)}
.btn-success:hover{transform:translateY(-1px)}
.btn-ghost{background:var(--surf2);border:1px solid var(--border);color:var(--text)}
.btn-ghost:hover{background:var(--surf3)}
.btn-full{width:100%;justify-content:center}
.btn:disabled{opacity:.5;cursor:not-allowed;transform:none!important}

/* ===== BILL SCREEN ===== */
#screen-bill{padding-bottom:60px}

.topbar{background:rgba(8,13,22,.9);backdrop-filter:blur(10px);
  border-bottom:1px solid var(--border);padding:0 16px;height:52px;
  display:flex;align-items:center;justify-content:space-between;
  position:sticky;top:0;z-index:50}
.topbar-left{display:flex;align-items:center;gap:10px}
.topbar-room{font-family:'Prompt',sans-serif;font-size:14px;font-weight:700;color:var(--water)}
.topbar-name{font-size:12px;color:var(--muted)}
.btn-logout{background:none;border:none;color:var(--muted);cursor:pointer;font-size:12px;padding:5px 10px;
  border-radius:7px;transition:background .15s;font-family:'Sarabun',sans-serif}
.btn-logout:hover{background:var(--surf2);color:var(--text)}

/* BILL HEADER */
.bill-hero{text-align:center;padding:32px 20px 20px;background:linear-gradient(180deg,rgba(15,24,40,.8) 0%,transparent 100%)}
.hero-month{font-size:12px;color:var(--muted);font-weight:600;letter-spacing:.07em;text-transform:uppercase;margin-bottom:6px}
.hero-amount{font-family:'Prompt',sans-serif;font-size:52px;font-weight:800;line-height:1;
  background:linear-gradient(135deg,#38bdf8,#fbbf24);
  -webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
.hero-unit{font-size:22px;font-weight:600}
.hero-sub{font-size:12px;color:var(--muted);margin-top:8px}
.hero-pill{display:inline-flex;align-items:center;gap:6px;padding:5px 14px;border-radius:20px;
  font-size:12px;font-weight:700;margin-top:10px}
.hp-pending{background:rgba(251,191,36,.1);border:1px solid rgba(251,191,36,.3);color:var(--elec)}
.hp-partial{background:rgba(56,189,248,.1);border:1px solid rgba(56,189,248,.3);color:var(--water)}
.hp-paid{background:rgba(251,146,60,.1);border:1px solid rgba(251,146,60,.3);color:var(--warn)}
.hp-confirmed{background:rgba(52,211,153,.1);border:1px solid rgba(52,211,153,.3);color:var(--ok)}

/* CONTENT */
.content{max-width:480px;margin:0 auto;padding:0 14px}

/* CARDS */
.card{background:var(--surf);border:1px solid var(--border);border-radius:var(--radius);
  padding:18px;margin-bottom:12px;animation:fadeUp .4s ease both}
.card-head{display:flex;align-items:center;gap:8px;margin-bottom:14px}
.cdot{width:8px;height:8px;border-radius:50%}
.card-title{font-family:'Prompt',sans-serif;font-size:13px;font-weight:700;color:var(--text)}
.info-row{display:flex;justify-content:space-between;align-items:flex-start;
  padding:8px 0;border-bottom:1px solid var(--border);font-size:13px;gap:10px}
.info-row:last-child{border-bottom:none;padding-bottom:0}
.ik{color:var(--muted);flex-shrink:0} .iv{font-weight:600;text-align:right}
.amt-row{display:flex;justify-content:space-between;align-items:center;
  padding:11px 13px;border-radius:11px;margin-bottom:7px;background:var(--surf2)}
.al{display:flex;flex-direction:column;gap:2px}
.an{font-size:13px;font-weight:600} .ad{font-size:11px;color:var(--muted)}
.ap{font-family:'Prompt',sans-serif;font-size:16px;font-weight:700}
.ap.w{color:var(--water)} .ap.e{color:var(--elec)} .ap.r{color:var(--rent)} .ap.f{color:var(--danger)}
.grand-row{display:flex;justify-content:space-between;align-items:center;padding:14px;
  background:linear-gradient(135deg,rgba(56,189,248,.07),rgba(251,191,36,.05));
  border:1px solid rgba(56,189,248,.18);border-radius:13px;margin-top:12px}
.gl{font-family:'Prompt',sans-serif;font-size:13px;font-weight:700}
.ga{font-family:'Prompt',sans-serif;font-size:20px;font-weight:800;
  background:linear-gradient(90deg,var(--water),var(--elec));
  -webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}

/* REMAINING */
.remaining-box{background:linear-gradient(135deg,rgba(248,113,113,.08),transparent);
  border:1px solid rgba(248,113,113,.2);border-radius:13px;padding:14px;margin-top:10px;
  display:flex;justify-content:space-between;align-items:center}
.remaining-box.done{background:linear-gradient(135deg,rgba(52,211,153,.07),transparent);border-color:rgba(52,211,153,.2)}
.rem-lbl{font-size:12px;color:var(--muted)}
.rem-amt{font-family:'Prompt',sans-serif;font-size:18px;font-weight:800}

/* PAYMENT SECTION */
.qr-display{display:flex;justify-content:center;margin:10px 0}
.qr-img{max-width:190px;max-height:190px;border-radius:13px;border:2px solid rgba(52,211,153,.3);
  object-fit:contain;background:#fff;padding:7px}
.bank-box{background:var(--surf2);border:1px solid var(--border);border-radius:12px;padding:14px}
.brow{display:flex;justify-content:space-between;font-size:13px;padding:4px 0}
.bk{color:var(--muted)} .bv{font-weight:700}
.bank-num{font-family:'Prompt',sans-serif;font-size:22px;font-weight:800;
  color:var(--elec);letter-spacing:.06em;text-align:center;padding:10px 0 6px}
.copy-btn{background:rgba(251,191,36,.08);border:1px solid rgba(251,191,36,.25);border-radius:8px;
  color:var(--elec);font-size:12px;font-weight:600;padding:7px 14px;cursor:pointer;
  width:100%;margin-top:8px;transition:background .15s;font-family:'Sarabun',sans-serif}
.copy-btn:hover{background:rgba(251,191,36,.15)}
.pay-divider{height:1px;background:var(--border);margin:16px 0}
.sub-label{font-size:10px;font-weight:700;color:var(--muted);text-align:center;
  letter-spacing:.08em;text-transform:uppercase;margin-bottom:12px}

/* SUBMIT PAYMENT */
.upload-zone{border:2px dashed var(--border);border-radius:12px;padding:18px;text-align:center;
  cursor:pointer;transition:border-color .2s,background .2s;background:var(--surf2);position:relative}
.upload-zone:hover{border-color:rgba(52,211,153,.4);background:rgba(52,211,153,.03)}
.upload-zone.has{border-color:rgba(52,211,153,.5)}
.upload-preview{max-width:100%;border-radius:10px;margin-top:10px;max-height:200px;object-fit:contain}

/* HISTORY */
.ph-item{background:var(--surf2);border:1px solid var(--border);border-radius:11px;
  padding:13px;margin-bottom:8px}
.ph-top{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:8px}
.pill{display:inline-flex;align-items:center;padding:3px 9px;border-radius:18px;font-size:10px;font-weight:700}
.pv{background:rgba(52,211,153,.1);border:1px solid rgba(52,211,153,.3);color:var(--ok)}
.pp{background:rgba(167,139,250,.1);border:1px solid rgba(167,139,250,.3);color:var(--rent)}
.pr{background:rgba(248,113,113,.1);border:1px solid rgba(248,113,113,.3);color:var(--danger)}

/* EMPTY / LOADING */
.empty{text-align:center;padding:50px 20px;color:var(--muted)}
.empty .eico{font-size:48px;margin-bottom:10px;opacity:.35}
.loading{text-align:center;padding:40px;color:var(--muted);font-size:13px;animation:pulse 1.5s infinite}

/* NO BILLS */
.no-bill-box{text-align:center;padding:60px 20px}
.no-bill-box .eico{font-size:56px;margin-bottom:14px;opacity:.3}

@keyframes fadeUp{from{opacity:0;transform:translateY(18px)}to{opacity:1;transform:translateY(0)}}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.4}}
</style>
</head>
<body>

<!-- CONFIG BANNER -->
<div id="configBanner">‚ö†Ô∏è ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Supabase ‚Äî ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÅ‡∏à‡πâ‡∏á‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö</div>

<!-- ===== LOGIN SCREEN ===== -->
<div class="screen active" id="screen-login">
  <div class="login-box">
    <div class="login-logo">
      <div class="icons"><span class="ico-w">üíß</span><span class="ico-e">‚ö°</span></div>
      <h1>‡∏£‡∏∞‡∏ö‡∏ö‡∏´‡∏≠‡∏û‡∏±‡∏Å</h1>
      <p>‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏ö‡∏¥‡∏•‡∏Ñ‡πà‡∏≤‡∏™‡∏≤‡∏ò‡∏≤‡∏£‡∏ì‡∏π‡∏õ‡πÇ‡∏†‡∏Ñ</p>
    </div>

    <div class="fg">
      <label>‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå</label>
      <input type="tel" id="login-phone" placeholder="0xx-xxx-xxxx" maxlength="12" oninput="fmtPhone(this)" onkeydown="if(event.key==='Enter')doLogin()">
    </div>
    <div class="fg">
      <label>‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô</label>
      <input type="text" id="login-id" placeholder="x-xxxx-xxxxx-xx-x" maxlength="17" oninput="fmtId(this)" onkeydown="if(event.key==='Enter')doLogin()">
    </div>
    <div class="login-err" id="login-err"></div>
    <button class="btn btn-primary btn-full" id="login-btn" onclick="doLogin()">üîê ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
    <div class="login-note">‡πÉ‡∏ä‡πâ‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡πÅ‡∏•‡∏∞‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô<br>‡∏ó‡∏µ‡πà‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏Å‡∏±‡∏ö‡∏ó‡∏≤‡∏á‡∏´‡∏≠‡∏û‡∏±‡∏Å‡πÑ‡∏ß‡πâ</div>

    <!-- Supabase settings (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö setup ‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏£‡∏Å) -->
    <div class="supa-note" id="supaSetupNote" style="display:none">
      ‚öôÔ∏è ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Supabase<br>
      <input type="text" id="t-url" placeholder="Supabase Project URL">
      <input type="text" id="t-key" placeholder="Supabase Anon Key" style="margin-top:6px">
      <button class="btn btn-ghost btn-full" style="margin-top:8px;font-size:12px" onclick="saveSupaSettings()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
    </div>
  </div>
</div>

<!-- ===== BILL SCREEN ===== -->
<div class="screen" id="screen-bill">
  <div class="topbar">
    <div class="topbar-left">
      <div>
        <div class="topbar-room" id="tb-room">‡∏´‡πâ‡∏≠‡∏á ‚Äî</div>
        <div class="topbar-name" id="tb-name"></div>
      </div>
    </div>
    <button class="btn-logout" onclick="logout()">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button>
  </div>

  <div class="bill-hero">
    <div class="hero-month" id="hero-month">‚Äî</div>
    <div class="hero-amount"><span id="hero-amt">0</span><span class="hero-unit"> ‡∏ö‡∏≤‡∏ó</span></div>
    <div class="hero-sub" id="hero-sub"></div>
    <div id="hero-pill"></div>
  </div>

  <div class="content" id="bill-content">
    <div class="loading">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏ö‡∏¥‡∏•...</div>
  </div>
</div>

<script>
// ============================================================
// CONFIG
// ============================================================
let SUPA_URL = localStorage.getItem('supa_url') || '';
let SUPA_KEY = localStorage.getItem('supa_key') || '';
let sb = null;
let currentTenant = null;
let currentBill = null;
let slipFile = null;

function initSupa() {
  if (!SUPA_URL || !SUPA_KEY) {
    document.getElementById('configBanner').style.display = 'block';
    document.getElementById('supaSetupNote').style.display = 'block';
    return false;
  }
  try {
    sb = supabase.createClient(SUPA_URL, SUPA_KEY);
    document.getElementById('configBanner').style.display = 'none';
    return true;
  } catch(e) { return false; }
}

function saveSupaSettings() {
  SUPA_URL = document.getElementById('t-url').value.trim();
  SUPA_KEY = document.getElementById('t-key').value.trim();
  if (!SUPA_URL || !SUPA_KEY) return;
  localStorage.setItem('supa_url', SUPA_URL);
  localStorage.setItem('supa_key', SUPA_KEY);
  if (initSupa()) document.getElementById('supaSetupNote').style.display = 'none';
}

initSupa();

// ============================================================
// FORMAT
// ============================================================
function fmtPhone(input) {
  let v = input.value.replace(/\D/g,'').substring(0,10);
  let f=''; for(let i=0;i<v.length;i++){if(i===3||i===6)f+='-';f+=v[i];}
  input.value=f;
}
function fmtId(input) {
  let v = input.value.replace(/\D/g,'').substring(0,13);
  let f=''; for(let i=0;i<v.length;i++){if(i===1||i===5||i===10||i===12)f+='-';f+=v[i];}
  input.value=f;
}
function fmt(n){return(parseFloat(n)||0).toLocaleString('th-TH',{minimumFractionDigits:2})}
function esc(s){return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;')}

// ============================================================
// LOGIN
// ============================================================
async function doLogin() {
  if (!sb) { showLoginErr('‡∏£‡∏∞‡∏ö‡∏ö‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏û‡∏£‡πâ‡∏≠‡∏° ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Supabase'); return; }
  const phone  = document.getElementById('login-phone').value.trim();
  const idCard = document.getElementById('login-id').value.trim();
  if (!phone || !idCard) { showLoginErr('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡πÅ‡∏•‡∏∞‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô'); return; }

  const btn = document.getElementById('login-btn');
  btn.disabled = true; btn.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö...';

  // Strip dashes for comparison
  const cleanPhone  = phone.replace(/-/g,'');
  const cleanIdCard = idCard.replace(/-/g,'');

  const { data, error } = await sb.from('tenants').select('*')
    .or(`phone.eq.${cleanPhone},phone.eq.${phone}`)
    .limit(20);

  btn.disabled = false; btn.innerHTML = 'üîê ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö';

  if (error || !data?.length) { showLoginErr('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÄ‡∏ä‡πà‡∏≤ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•'); return; }

  const tenant = data.find(t => {
    const tp = (t.phone||'').replace(/-/g,'');
    const ti = (t.id_card||'').replace(/-/g,'');
    return (tp === cleanPhone) && (ti === cleanIdCard);
  });

  if (!tenant) { showLoginErr('‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á'); return; }

  currentTenant = tenant;
  showBillScreen();
}

function showLoginErr(msg) {
  const el = document.getElementById('login-err');
  el.textContent = msg; el.style.display = 'block';
  setTimeout(() => el.style.display = 'none', 4000);
}

// ============================================================
// BILL SCREEN
// ============================================================
async function showBillScreen() {
  document.getElementById('screen-login').classList.remove('active');
  document.getElementById('screen-bill').classList.add('active');
  document.getElementById('tb-room').textContent = '‡∏´‡πâ‡∏≠‡∏á ' + (currentTenant.room || '‚Äî');
  document.getElementById('tb-name').textContent = currentTenant.name || '';
  await loadLatestBill();
}

async function loadLatestBill() {
  const content = document.getElementById('bill-content');
  content.innerHTML = '<div class="loading">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏ö‡∏¥‡∏•...</div>';

  // Get latest bill for this tenant
  const { data: bills } = await sb.from('bills')
    .select('*').eq('tenant_id', currentTenant.id)
    .order('issued_at', { ascending: false }).limit(10);

  if (!bills?.length) {
    content.innerHTML = `<div class="no-bill-box"><div class="eico">üì≠</div>
      <div style="font-family:'Prompt',sans-serif;font-size:17px;color:var(--muted);margin-bottom:6px">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ö‡∏¥‡∏•</div>
      <div style="font-size:13px;color:var(--muted)">‡∏£‡∏≠‡∏£‡∏±‡∏ö‡∏ö‡∏¥‡∏•‡∏à‡∏≤‡∏Å‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏´‡∏≠‡∏û‡∏±‡∏Å</div></div>`;
    return;
  }

  // Show latest pending/partial bill first, else latest
  currentBill = bills.find(b => b.status === 'pending' || b.status === 'partial') || bills[0];

  renderBill(currentBill, bills);
}

async function renderBill(b, allBills) {
  // Hero
  document.getElementById('hero-month').textContent = '‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡πÄ‡∏î‡∏∑‡∏≠‡∏ô ' + (b.month_label||'‚Äî');
  document.getElementById('hero-amt').textContent = fmt(b.total);
  document.getElementById('hero-sub').textContent = b.issued_at ? '‡∏≠‡∏≠‡∏Å‡∏ö‡∏¥‡∏•‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ' + new Date(b.issued_at).toLocaleDateString('th-TH') : '';
  const pillMap = {
    pending:  ['hp-pending', '‚è≥ ‡∏£‡∏≠‡∏ä‡∏≥‡∏£‡∏∞'],
    partial:  ['hp-partial', 'üíß ‡∏ä‡∏≥‡∏£‡∏∞‡∏ö‡∏≤‡∏á‡∏™‡πà‡∏ß‡∏ô'],
    paid:     ['hp-paid',    'üì§ ‡∏£‡∏≠‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô'],
    confirmed:['hp-confirmed','‚úÖ ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÅ‡∏•‡πâ‡∏ß']
  };
  const [pcls, ptxt] = pillMap[b.status] || ['hp-pending', b.status];
  document.getElementById('hero-pill').innerHTML = `<div class="hero-pill ${pcls}">${ptxt}</div>`;

  // Get payments for this bill
  const { data: pays } = await sb.from('payments').select('*').eq('bill_id', b.id).order('paid_at');
  const verifiedTotal = (pays||[]).filter(p=>p.status==='verified').reduce((s,p)=>s+(p.amount||0),0);
  const remaining = Math.max(0, (b.total||0) - verifiedTotal);

  let html = '';

  // Items
  html += `<div class="card" style="animation-delay:.05s">
    <div class="card-head"><div class="cdot" style="background:var(--elec);box-shadow:0 0 6px rgba(251,191,36,.5)"></div><span class="card-title">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢</span></div>`;
  if (b.rent > 0)  html += amtRow('üè† ‡∏Ñ‡πà‡∏≤‡∏´‡πâ‡∏≠‡∏á‡∏û‡∏±‡∏Å', '‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡πÄ‡∏î‡∏∑‡∏≠‡∏ô '+esc(b.month_label||''), b.rent, 'r');
  if (b.water > 0 || b.water_units > 0) html += amtRow('üíß ‡∏Ñ‡πà‡∏≤‡∏ô‡πâ‡∏≥', '‡πÉ‡∏ä‡πâ‡πÑ‡∏õ '+(b.water_units||0)+' ‡∏´‡∏ô‡πà‡∏ß‡∏¢', b.water, 'w');
  if (b.elec  > 0 || b.elec_units  > 0) html += amtRow('‚ö° ‡∏Ñ‡πà‡∏≤‡πÑ‡∏ü',   '‡πÉ‡∏ä‡πâ‡πÑ‡∏õ '+(b.elec_units||0)+' ‡∏´‡∏ô‡πà‡∏ß‡∏¢', b.elec,  'e');
  if (b.fine  > 0) html += amtRow('‚ö†Ô∏è ‡∏Ñ‡πà‡∏≤‡∏õ‡∏£‡∏±‡∏ö', b.fine_reason||'‡∏Ñ‡πà‡∏≤‡∏õ‡∏£‡∏±‡∏ö', b.fine, 'f');
  html += `<div class="grand-row"><span class="gl">üí∞ ‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏™‡∏¥‡πâ‡∏ô</span><span class="ga">${fmt(b.total)} ‡∏ö‡∏≤‡∏ó</span></div>`;
  // Remaining
  if (verifiedTotal > 0) {
    html += `<div style="margin-top:8px;font-size:12px;color:var(--ok);text-align:right">‚úÖ ‡∏ä‡∏≥‡∏£‡∏∞‡πÅ‡∏•‡πâ‡∏ß ${fmt(verifiedTotal)} ‡∏ö‡∏≤‡∏ó</div>`;
  }
  if (remaining > 0 && verifiedTotal > 0) {
    html += `<div class="remaining-box"><div><div class="rem-lbl">‡∏¢‡∏±‡∏á‡∏Ñ‡πâ‡∏≤‡∏á‡∏ä‡∏≥‡∏£‡∏∞</div></div><div class="rem-amt" style="color:var(--danger)">${fmt(remaining)} ‡∏ö‡∏≤‡∏ó</div></div>`;
  } else if (remaining <= 0) {
    html += `<div class="remaining-box done"><div class="rem-lbl">‡∏ä‡∏≥‡∏£‡∏∞‡∏Ñ‡∏£‡∏ö‡πÅ‡∏•‡πâ‡∏ß ‚úÖ</div><div class="rem-amt" style="color:var(--ok)">${fmt(b.total)} ‡∏ö‡∏≤‡∏ó</div></div>`;
  }
  html += '</div>';

  // Payment methods
  const hasQr   = !!b.payment_qr;
  const hasBank = !!(b.bank_number || b.bank_name);
  if (hasQr || hasBank) {
    html += `<div class="card" style="animation-delay:.1s">
      <div class="card-head"><div class="cdot" style="background:var(--ok);box-shadow:0 0 6px rgba(52,211,153,.5)"></div><span class="card-title">üí≥ ‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏á‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô</span></div>`;
    if (hasQr) {
      html += `<div class="sub-label">QR ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÄ‡∏û‡∏¢‡πå</div>
        <div class="qr-display"><img src="${b.payment_qr}" class="qr-img"></div>
        <div style="font-size:11px;color:var(--muted);text-align:center;margin-bottom:${hasBank?'0':'4px'}">‡∏™‡πÅ‡∏Å‡∏ô‡∏î‡πâ‡∏ß‡∏¢ Mobile Banking</div>`;
    }
    if (hasQr && hasBank) html += '<div class="pay-divider"></div>';
    if (hasBank) {
      html += `<div class="sub-label">‡πÇ‡∏≠‡∏ô‡∏ú‡πà‡∏≤‡∏ô‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£</div>
        <div class="bank-box">
          <div class="brow"><span class="bk">‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£</span><span class="bv">${esc(b.bank_name||'‚Äî')}</span></div>
          <div class="bank-num" id="bnum">${esc(b.bank_number||'‚Äî')}</div>
          <div class="brow" style="border-top:1px solid var(--border);padding-top:10px;margin-top:6px">
            <span class="bk">‡∏ä‡∏∑‡πà‡∏≠‡∏ö‡∏±‡∏ç‡∏ä‡∏µ</span><span class="bv">${esc(b.bank_account_name||'‚Äî')}</span>
          </div>
          <button class="copy-btn" onclick="copyBankNum()">üìã ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ç‡∏ä‡∏µ</button>
        </div>`;
    }
    html += '</div>';
  }

  // Submit payment (only if not confirmed and remaining > 0)
  if (b.status !== 'confirmed' && remaining > 0) {
    html += `<div class="card" style="animation-delay:.15s" id="paySubmitCard">
      <div class="card-head"><div class="cdot" style="background:var(--rent);box-shadow:0 0 6px rgba(167,139,250,.5)"></div><span class="card-title">üì§ ‡πÅ‡∏à‡πâ‡∏á‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô</span></div>
      <div style="font-size:12px;color:var(--muted);margin-bottom:14px">‡πÅ‡∏ô‡∏ö‡∏™‡∏•‡∏¥‡∏õ‡πÅ‡∏•‡∏∞‡∏Å‡∏£‡∏≠‡∏Å‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏µ‡πà‡πÇ‡∏≠‡∏ô</div>
      <div style="display:flex;flex-direction:column;gap:10px">
        <div class="fg">
          <label>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏µ‡πà‡∏ä‡∏≥‡∏£‡∏∞ (‡∏ö‡∏≤‡∏ó)</label>
          <input type="number" id="pay-amount" placeholder="${fmt(remaining)}" max="${remaining}" value="${remaining}">
        </div>
        <div class="fg">
          <label>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏ (‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö)</label>
          <input type="text" id="pay-note" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡πÇ‡∏≠‡∏ô‡∏ö‡∏≤‡∏á‡∏™‡πà‡∏ß‡∏ô">
        </div>
        <div>
          <label style="display:block;margin-bottom:6px">‡∏™‡∏•‡∏¥‡∏õ‡∏Å‡∏≤‡∏£‡πÇ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô</label>
          <div class="upload-zone" id="uploadZone" onclick="document.getElementById('slipInput').click()">
            <div id="uploadPlaceholder"><div style="font-size:28px;margin-bottom:6px">üìé</div><div style="font-size:13px;color:var(--muted)">‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏õ‡∏™‡∏•‡∏¥‡∏õ</div><div style="font-size:11px;color:var(--muted);margin-top:3px">PNG, JPG ‡∏Ç‡∏ô‡∏≤‡∏î‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô 5MB</div></div>
            <img id="slipPreview" style="display:none" class="upload-preview">
          </div>
          <input type="file" id="slipInput" accept="image/*" style="display:none" onchange="handleSlip(event)">
        </div>
        <button class="btn btn-success btn-full" id="submitPayBtn" onclick="submitPayment('${b.id}')">
          üì§ ‡∏™‡πà‡∏á‡∏´‡∏•‡∏±‡∏Å‡∏ê‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞
        </button>
      </div>
    </div>`;
  } else if (b.status === 'confirmed') {
    html += `<div class="card" style="animation-delay:.15s;border-color:rgba(52,211,153,.3);background:rgba(52,211,153,.04)">
      <div style="text-align:center;padding:10px 0">
        <div style="font-size:36px;margin-bottom:8px">‚úÖ</div>
        <div style="font-family:'Prompt',sans-serif;font-size:16px;font-weight:700;color:var(--ok)">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÅ‡∏•‡πâ‡∏ß</div>
        <div style="font-size:12px;color:var(--muted);margin-top:6px">‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡∏´‡∏≠‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏ö‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß</div>
      </div>
    </div>`;
  } else if (remaining <= 0) {
    html += `<div class="card" style="animation-delay:.15s;border-color:rgba(251,146,60,.3)">
      <div style="text-align:center;padding:10px 0">
        <div style="font-size:36px;margin-bottom:8px">üì§</div>
        <div style="font-family:'Prompt',sans-serif;font-size:16px;font-weight:700;color:var(--warn)">‡∏£‡∏≠‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡∏´‡∏≠‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô</div>
        <div style="font-size:12px;color:var(--muted);margin-top:6px">‡∏£‡∏∞‡∏ö‡∏ö‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏™‡∏•‡∏¥‡∏õ‡πÅ‡∏•‡πâ‡∏ß ‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏à‡∏≤‡∏Å‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡∏´‡∏≠</div>
      </div>
    </div>`;
  }

  // Payment history
  if (pays && pays.length) {
    html += `<div class="card" style="animation-delay:.2s">
      <div class="card-head"><div class="cdot" style="background:var(--muted)"></div><span class="card-title">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞</span></div>`;
    pays.forEach(p => {
      html += `<div class="ph-item">
        <div class="ph-top">
          <div>
            <div style="font-weight:700;font-size:15px">${fmt(p.amount)} ‡∏ö‡∏≤‡∏ó</div>
            <div style="font-size:11px;color:var(--muted)">${new Date(p.paid_at).toLocaleString('th-TH')}</div>
            ${p.note?`<div style="font-size:12px;color:var(--muted);margin-top:2px">${esc(p.note)}</div>`:''}
          </div>
          <span class="pill ${p.status==='verified'?'pv':p.status==='rejected'?'pr':'pp'}">${p.status==='verified'?'‚úÖ ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô':p.status==='rejected'?'‚ùå ‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò':'üîç ‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à'}</span>
        </div>
        ${p.slip_url?`<img src="${p.slip_url}" style="max-width:100%;border-radius:9px;max-height:160px;object-fit:contain;cursor:pointer" onclick="window.open('${p.slip_url}','_blank')">`:''}
      </div>`;
    });
    html += '</div>';
  }

  // Other bills selector
  if (allBills && allBills.length > 1) {
    html += `<div class="card" style="animation-delay:.25s">
      <div class="card-head"><div class="cdot" style="background:var(--muted)"></div><span class="card-title">‡∏ö‡∏¥‡∏•‡∏≠‡∏∑‡πà‡∏ô‡πÜ</span></div>
      <div style="display:flex;flex-direction:column;gap:7px">
        ${allBills.filter(x=>x.id!==b.id).map(x=>`
          <button onclick="switchBill('${x.id}')" style="display:flex;justify-content:space-between;align-items:center;padding:10px 13px;background:var(--surf2);border:1px solid var(--border);border-radius:10px;cursor:pointer;color:var(--text);font-family:'Sarabun',sans-serif;font-size:13px">
            <span>${esc(x.month_label)}</span>
            <div style="display:flex;align-items:center;gap:8px">
              <span style="font-family:'Prompt',sans-serif;font-weight:700">${fmt(x.total)} ‡∏ö‡∏≤‡∏ó</span>
              ${statusMini(x.status)}
            </div>
          </button>`).join('')}
      </div>
    </div>`;
  }

  document.getElementById('bill-content').innerHTML = html;
  slipFile = null;
}

function amtRow(name, detail, amount, cls) {
  return `<div class="amt-row"><div class="al"><span class="an">${name}</span><span class="ad">${detail}</span></div><span class="ap ${cls}">${fmt(amount)} ‡∏ö‡∏≤‡∏ó</span></div>`;
}

function statusMini(s) {
  const m = {pending:'pill-pending ‚è≥',partial:'pill-partial üíß',paid:'pill-paid üì§',confirmed:'pill-confirmed ‚úÖ'};
  const parts = (m[s]||'pill-pending ‚è≥').split(' ');
  return `<span class="pill ${parts[0]}">${parts[1]}</span>`;
}

async function switchBill(billId) {
  const { data: bills } = await sb.from('bills').select('*').eq('tenant_id', currentTenant.id).order('issued_at',{ascending:false});
  currentBill = bills.find(b => b.id === billId);
  renderBill(currentBill, bills);
  window.scrollTo({ top: 0, behavior: 'smooth' });
}

// ============================================================
// SLIP UPLOAD
// ============================================================
function handleSlip(e) {
  const f = e.target.files[0]; if (!f) return;
  if (f.size > 5*1024*1024) { alert('‡∏£‡∏π‡∏õ‡πÉ‡∏´‡∏ç‡πà‡πÄ‡∏Å‡∏¥‡∏ô 5MB'); return; }
  slipFile = f;
  const r = new FileReader();
  r.onload = ev => {
    document.getElementById('uploadPlaceholder').style.display = 'none';
    const img = document.getElementById('slipPreview');
    img.src = ev.target.result; img.style.display = 'block';
    document.getElementById('uploadZone').classList.add('has');
  };
  r.readAsDataURL(f);
}

async function submitPayment(billId) {
  const amount = parseFloat(document.getElementById('pay-amount').value);
  const note   = document.getElementById('pay-note').value.trim();
  if (!amount || amount <= 0) { alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô'); return; }
  if (!slipFile) { alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÅ‡∏ô‡∏ö‡∏™‡∏•‡∏¥‡∏õ‡∏Å‡∏≤‡∏£‡πÇ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô'); return; }

  const btn = document.getElementById('submitPayBtn');
  btn.disabled = true; btn.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î...';

  let slipUrl = '';
  try {
    const ext  = slipFile.name.split('.').pop();
    const path = `slips/${billId}_${Date.now()}.${ext}`;
    const { data: upData, error: upErr } = await sb.storage.from('slips').upload(path, slipFile);
    if (upErr) throw upErr;
    const { data: urlData } = sb.storage.from('slips').getPublicUrl(path);
    slipUrl = urlData.publicUrl;
  } catch(e) {
    btn.disabled = false; btn.innerHTML = 'üì§ ‡∏™‡πà‡∏á‡∏´‡∏•‡∏±‡∏Å‡∏ê‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞';
    alert('‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏•‡∏¥‡∏õ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + (e.message||e));
    return;
  }

  const { error } = await sb.from('payments').insert({
    bill_id: billId, amount, slip_url: slipUrl, note, status: 'pending_verify'
  });

  if (error) {
    btn.disabled = false; btn.innerHTML = 'üì§ ‡∏™‡πà‡∏á‡∏´‡∏•‡∏±‡∏Å‡∏ê‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞';
    alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error.message); return;
  }

  // Update bill status to partial/paid
  const { data: allPays } = await sb.from('payments').select('*').eq('bill_id', billId);
  const paid = (allPays||[]).filter(p=>p.status==='verified').reduce((s,p)=>s+(p.amount||0),0);
  const newStatus = paid >= (currentBill?.total||0) ? 'paid' : 'partial';
  await sb.from('bills').update({ status: newStatus }).eq('id', billId);

  // Create notification for admin
  await sb.from('notifications').insert({
    type: 'payment_submitted',
    bill_id: billId,
    message: `‡∏´‡πâ‡∏≠‡∏á ${currentTenant.room} ‚Äî ${currentTenant.name} ‡∏™‡πà‡∏á‡∏´‡∏•‡∏±‡∏Å‡∏ê‡∏≤‡∏ô‡∏ä‡∏≥‡∏£‡∏∞ ${amount.toLocaleString('th-TH')} ‡∏ö‡∏≤‡∏ó`
  });

  slipFile = null;
  await loadLatestBill();
}

// ============================================================
// UTILS
// ============================================================
function copyBankNum() {
  const num = document.getElementById('bnum')?.textContent;
  if (!num) return;
  navigator.clipboard.writeText(num).then(() => {
    const btn = document.querySelector('.copy-btn');
    if (btn) { btn.textContent = '‚úÖ ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß'; setTimeout(() => btn.textContent = 'üìã ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ç‡∏ä‡∏µ', 2000); }
  });
}

function logout() {
  currentTenant = null; currentBill = null;
  document.getElementById('screen-bill').classList.remove('active');
  document.getElementById('screen-login').classList.add('active');
  document.getElementById('login-phone').value = '';
  document.getElementById('login-id').value = '';
}
</script>
</body>
</html>
